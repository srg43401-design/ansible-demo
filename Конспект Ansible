	Конспект Ansible

	Основная концепция модулей

Определение: Модули в Ansible - это небольшие блоки кода, предназначенные для выполнения определенных задач на хостах. Они позволяют выполнять команды и собирать возвращаемые значения.

Назначение: Инкапсулируют функциональности, предоставляя простой интерфейс для их вызова.

Источники: Некоторые модули уже встроены в установленный Ansible, другие можно добавить из Ansible Galaxy.

Пример использования модуля

Для запуска сервиса HTTPD используется модуль service, в который через аргументы можно передать дополнительные параметры.

Работа с модулями

Поиск модулей:

В интернете через поисковой запрос "Ansible module list" для доступа к справочнику модулей.

Через командную строку с использованием ansible-doc, которая показывает документацию по модулям в Vim-подобном интерфейсе.

Практические советы

Изучение документации:

Сначала рассмотреть примеры использования для понимания общих сценариев.
Затем подробно ознакомиться с параметрами команд, чтобы правильно их настроить под свои задачи.

Понимание возвращаемых значений:

Важно изучить, какие значения возвращает команда, так как эти данные могут быть использованы в последующих командах внутри плейбука.


______________________________________
______________________________________
______________________________________
______________________________________
______________________________________
______________________________________

	9.8. Ad-hoc команды

Полезны для быстрых исправлений и получения информации с серверов.
Пример сравнения: docker run (разовое действие) против docker-compose (описание полного стека сервисов).

Основное содержание:

Определение и использование:

Команды для однократного выполнения задач.
Не сохраняются для последующего использования, в отличии от плейбуков.
Примеры использования: быстрые исправления, получение информации о серверах, тестирование команд.

Синтаксис:

Команда запускается с указанием хоста, модуля и аргументов (ansible -i <инвентарь> -m <модуль> -a <аргументы>).

Ограничение: можно использовать только один модуль за команду.

Практическое применение:

Создание и удаление пользователя с использованием модуля User.
Обработка ошибок и необходимость прав суперпользователя (sudo).

Параметры команды Ansible:

Различные параметры для выполнения команд, включая --ask-become-pass для запроса пароля sudo.

Примеры использования ad-hoc команд:

Создание пользователя с использованием судо.
Удаление пользователя.

Работа с переменными:

Использование переменных (--extra-vars) для передачи дополнительной информации команде.

Небезопасный метод хранения паролей в открытом доступе не рекомендуется.

______________________________________
______________________________________
______________________________________
______________________________________
______________________________________
______________________________________

	10.1. Простейший playbook

Основная концепция:
Плейбуки являются ключевым элементом Ansible, предназначенными для создания, сохранения и повторного использования скриптов конфигурации. Они служат источником документации текущей настройки инфраструктуры.

Что такое плейбук:

Описывает конфигурацию, оркестрацию или развертывание на серверах.
Может указывать на желаемое состояние системы или перечислять шаги установки.
Структура плейбука:

YAML файл начинается с имени плейбука.
Определяются группы хостов, на которых будет исполняться плейбук.
Список задач (tasks), аналогичных ad hoc командам, используя модули с параметрами.
Пример создания простого плейбука для управления пользователем:

Назначаем имя плейбуку и определяем хосты.
Вписываем задачи, например, создание пользователя с помощью модуля user и задаем параметры.
Исполнение плейбука:

Используем команду ansible-playbook с указанием инвентарного файла и самого плейбука.
Можно запросить sudo пароль через параметр -K, если необходимо.
Дополнительные функции:

В случае ошибок детали выводятся для диагностики.
Обсуждается возможность использования Vault для безопасной передачи паролей на группу серверов.	

______________________________________
______________________________________
______________________________________
______________________________________
______________________________________
______________________________________


	Основы переменных

Что такое переменные в Ansible: 

Переменные используются для динамического управления значениями в плейбуке, позволяя переиспользовать и легко изменять данные.

Применение переменных:

Переиспользование значений в разных частях плейбука или на разных серверах.
Использование разных значений в разных окружениях (например, количество инстансов на продакшене и в разработке).
Централизованное управление конфигурациями (например, настройки почты).

Ограничения использования переменных

Избегайте ключевых слов Python (Ansible построен на Python).
Не начинайте переменные со звездочки, пробелов, точек, дефисов и цифр.
Где задавать переменные
Места задания переменных: В плейбуке, блоках тасков, тасках, инвентаре, через группы GroupVars и HostVars, и используя ExtraVars.

Практическое использование переменных в Ansible

Примеры:

В таске: Прямое объявление переменной в разделе vars.
В плейбуке: Объявление переменной на уровне плейбука.
Через файл: Использование vars_files для задания переменной через внешний файл.
Используя плагин: GroupVars и HostVars для автоматического определения переменных из определенных директорий.

Приоритизация переменных

Переменные с одинаковыми именами будут перезаписаны на основе их источника и приоритета от самых низкоуровневых (например, аргументы командной строки) до самых высокоуровневых (например, ExtraVars).
Чем более специфичен контекст, в котором задана переменная, тем выше её приоритет.

Варианты задания переменных

Интерактивно с помощью vars_prompt: Позволяет запрашивать у пользователя ввод переменных при запуске плейбука.
Использование ExtraVars для динамической передачи переменных
При помощи ExtraVars можно передавать переменные при вызове плейбука, что обеспечивает большую гибкость при выполнении задач.

______________________________________
______________________________________
______________________________________
______________________________________
______________________________________
______________________________________


	10.3. Отладка

Введение

Ansible Playbook часто рассматриваются как простые, но на практике могут быть большими и содержать много ролей и задач.
Цель отладки - понять, почему что-то не работает.

Способы отладки

Вывод в консоль

Аналогично Console.log в JavaScript.
Используется для вывода результатов команд в консоль.

В Ansible для вывода используется регистрация вывода команды с помощью ключа register и последующее использование debug для вывода зарегистрированной переменной.

Режим отладки

Включается через debugger с различными опциями (always, never, on_failed, on_unreachable, on_skip).

Позволяет запустить режим отладки перед выполнением задачи.

Пример использования вывода в консоль
Регистрация вывода команды: задаем переменную out через ключ register.

---
- name: user
  hosts: demo
  tasks:
    - name: Create user
      vars:
        user: w
      user: 
        name: "{{ user }}"
        state: present
      become: true
      register: out
    - debug:
        var: out

Вывод с помощью debug: 

используем debug, указывая out как переменную для вывода.

Пример использования режима отладки

Настройка режима: 

устанавливаем 
debugger: always 
для включения режима отладки независимо от обстоятельств.

---
- name: user
  hosts: demo
  tasks:
    - name: Create user
      vars:
        user: w
      user: 
        name: "{{ user }}"
        state: present
      become: true
      debugger: always

Использование команд в режиме отладки:

p или print 
для вывода переменных.

> p task
TASK: Create user
> p task.name
'Create user'
> p task.args
> p task.vars
{'user': 'w'}
> p task_vars
> p task_vars['inventory_hostname']
'127.0.0.1'
> p task_vars['user']
'w'
> task.args['name']='e'
> p task_vars['user']
'e'
> task.args['state']='absent'
> r
changed: [127.0.0.1]
> p task.args
'name': 'e',
'state': 'absent'

Изменение текущих аргументов и повторное выполнение таска с помощью 
r (retry).
Продолжение выполнения плейбука с помощью c (continue) 
или обновление таска с измененными переменными через 
U (updateTask)

> u
> c


______________________________________
______________________________________
______________________________________
______________________________________
______________________________________

	10.4. Блоки и обработка ошибок


1. Введение:

Объяснение необходимости использования блоков для группирования задач (тасков) с общими параметрами.

Создание примера с задачами 
"Create User" и 
"Install curl".

2. Создание и использование блоков:

Демонстрация как объединить задачи в блоки и как на уровне блока задать общие параметры, например, 
become 
для повышения прав.

3. Обработка ошибок с использованием блоков:

Введение в конструкции 
rescue и 
always 
для управления ошибками.

Пример использования блоков для обработки ошибки и выполнения кода вне зависимости от наличия ошибки.

4. Подробное рассмотрение блоков rescue и always:

rescue используется для задач, которые должны выполниться в случае возникновения ошибки.

always служит для выполнения задач, необходимых выполнить в любом случае, независимо от ошибок.

---
- name: user
  hosts: demo
  tasks:
    - name: Preconfig block
      block:
        - name: Create user
          vars:
            user: w
          user: 
            name: "{{ user }}"
            state: present
          register: error
        - name: Install curl
          apt: 
            name: curl
            update-cache: yes
          register: error
      become: true
      rescue:
        - name: Some error print
          debug:
            var: error
      always:
        - name: Reboot
          debug:
            msg: "Rebooooting"


5. Управление ошибками и дополнительные параметры:

Использование параметров anyErrorFatal 

---
- name: user
  hosts: demo
  any_errors_fatal: true
  tasks:

и ignoreErrors для гибкого управления ошибками.

---
- name: user
  hosts: demo
  tasks:
    - name: Preconfig block
      block:
        - name: Create user
          vars:
            user: w
          user: 
            name: "{{ user }}"
            state: present
          register: error
          ignore_errors: yes

Описаны случаи использования и возможности параметров.

________- name: fail on FAILED
          command: echo "FAILED"
          register: command_result
          failed_when: "'FAILED' in command_result.stdout"

6. Условия выполнения блоков:

Использование when для контроля над условиями выполнения блоков в зависимости от операционной системы хоста или других условий.

______when: ansible_facts['distribution'] == 'CentOS'

______________________________________
______________________________________
______________________________________
______________________________________
______________________________________


	10.5. Асинхронные задачи

Цели:

Понять, как использовать асинхронность для оптимизации плейбуков.
Изучить ключи асинхронности 
async и poll.

Основные моменты:

Понятие асинхронности в Ansible:

Использование для запуска параллельных задач на одном сервере.
Предотвращение таймаутов SSH для длительных задач.

Настройка асинхронности:

async: 
Максимальное время выполнения задачи в секундах.

poll: 
Периодичность проверки состояния задачи в секундах.

Примеры использования:

Тяжеловесные задачи: 
Задачи с 
poll больше 0 
для регулярной проверки статуса.

Параллельные задачи: 
Задачи с 
poll равным 0 
для немедленного перехода к следующей задаче без проверки статуса.

Практические кейсы:

Исполнение команды 
sleep 
для демонстрации асинхронности.
---
- name: user
  hosts: demo
  tasks:
    - name: Preconfig block
      block:
        - name: Sleep
          command: /bin/sleep 15
          async: 1000
          poll: 5
      become: true

Перезагрузка сервера с использованием асинхронности, чтобы избежать ошибок отсутствия ответа.

Встроенные модули vs команды:

Рекомендуется использовать встроенные модули Ansible для общих задач (например, reboot) из-за их удобства и встроенного функционала.

Async и оптимизация:

Асинхронное выполнение позволяет эффективнее использовать ресурсы сервера и сократить время настройки и развертывания продуктов на множестве серверов.
---
- name: user
  hosts: demo
  tasks:
    - name: Preconfig block
      block:
        - name: Sleep
          command: /bin/sleep 15
          async: 1000
          poll: 0
          register: sleep
        - debug:
            var: sleep
        - name: Echo
          command: echo "DONE" 
      become: true
    - name: Check sleep status
      async_status: 
        jid: "{{ sleep.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 100
      delay: 1
      become: true

---
- name: user
  hosts: demo
  tasks:
    - name: Preconfig block
      block:
        - name: Reboot
          shell: "sleep 2 && reboot"
          async: 1000
          poll: 0
      become: true

Дополнительно:

https://docs.ansible.com/ansible/2.9/modules/wait_for_module.html#wait-for-module

Модуль 
WaitFor 
для ожидания определенных условий или таймаутов, когда конкретный триггер отсутствует.

______________________________________
______________________________________
______________________________________
______________________________________
______________________________________

  10.6. Упражнение - Пишем настройку сервера

Цель упражнения

Цель - написать настройку сервера с использованием Ansible, включающая установку Docker, Docker Compose, добавление прав пользователя и перезагрузка сервера.

Модули Ansible

APT (apt, apt-repository, apt-key): Управление пакетами и репозиториями.
Service: Работа с системными службами.
Get URL: Скачивание файлов из интернета.
User: Управление пользователями.
Reboot: Перезагрузка системы.

Шаги установки

Установка Docker:

Добавление репозитория Universe.
Установка дополнительных пакетов (apt-transport-https, ce-certificates, и др.).
Добавление ключа Docker и репозитория.
Установка Docker CE (Docker Community Edition).
Перезагрузка сервиса Docker.

Установка Docker Compose (уже не нужно в последних версиях):

Получение последней версии Docker Compose через API GitHub.
Скачивание и установка Docker Compose в /usr/local/bin/docker-compose.
Настройка прав доступа.
Добавление пользователя в группу Docker и перезагрузка:
Добавить текущего пользователя в группу Docker.
Выполнить перезагрузку сервера.

Работа с Ansible

Используется две переменные: 

ansible_user (текущий пользователь) и 
ansible_distribution_release (релиз дистрибутива Ubuntu), 

позволяющие сделать скрипт независимым от версии операционной системы.

Вместо прямых команд предпочтение отдается модулям Ansible для лучшей читаемости и независимости от наличия определенных утилит на сервере.

Использование Become: Yes важно для выполнения задач от имени суперпользователя.

Тестирование и исправления

Процесс тестирования показывает как отслеживать и исправлять ошибки в скрипте Ansible.

После успешного тестирования, скрипт готов к использованию для автоматизации настройки серверов.

---
- name: Preconfig
  hosts: demo
  become: yes  
  tasks:
    - name: Установка Docker
      block:
        - name: Добавляем universe
          apt_repository:
            repo: "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} universe"
            state: present

    - name: Установка дополнительных пакетов
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        update-cache: yes
        cache_valid_time: 86400

    - name: Добавление ключа Docker
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
        keyring: /usr/share/keyrings/docker-archive-keyring.gpg

    - name: Установка стабильного репозитория
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present 
        update_cache: yes
        filename: docker

    - name: Установка Docker-ce
      apt:
        name: docker-ce
        update_cache: yes

    - name: Проверка что модуль установлен и перезагружен
      service:
        name: docker
        state: restarted
        enabled: yes

    - name: Установка Docker-compose
      block:
      - name: Получение последней версии Docker-compose
        uri:
          url: https://api.github.com/repos/docker/compose/releases/latest
          body_format: json
        register: page

      - name: Установка Docker-compose
        get_url:
          url: "https://github.com/docker/compose/releases/download/{{ page.json.tag_name }}/docker-compose-linux-x86_64"
          dest: /usr/local/bin/docker-compose
          mode: '0755'

    - name: Завершение установки
      block:
        - name: Добавление пользователя в группу docker
          user:
            name: '{{ ansible_user }}'
            groups: docker
            append: yes
        - name: Перезагрузка сервера
          reboot:

______________________________________
______________________________________
______________________________________
______________________________________
______________________________________


10.7. Ansible lint


Обзор:

Что такое Ansible Lint? Утилита для линтинга кода в Ansible, позволяющая обеспечить единый стандарт форматирования кода в команде.
Зачем использовать? Помогает обнаруживать стилистические ошибки и обеспечивает соблюдение установленных командой правил.
Установка: Может быть установлен через pip для Windows/Linux или brew для Mac.
Использование Ansible Lint:

Пример проверки файла: Запуск ansible-lint config.yaml для выявления оформительских ошибок.
Настройка правил: Возможность конфигурации через файл .ansible-lint в корне проекта, включая игнорирование определённых путей или правил.
Кастомизация: Поддерживает написание собственных правил на Python (не освещается в нашем курсе).
Интеграция с pre-commit:

Что такое pre-commit hook? Механизм, позволяющий автоматически запускать проверку кода перед каждым коммитом.
Настройка pre-commit hook с Ansible Lint:
Установка pre-commit через homebrew или pip.
Выполнение pre-commit install в директории репозитория.
Создание файла .pre-commit-config.yaml с указанием правил и версии ansible-lint.
Примеры и практика:

Демонстрация устранения типичных ошибок, выявленных с помощью Ansible Lint.
Настройка pre-commit hook для автоматической проверки кода перед коммитом и обсуждение практического применения.