	Конспект Ansible

	Основная концепция модулей

Определение: Модули в Ansible - это небольшие блоки кода, предназначенные для выполнения определенных задач на хостах. Они позволяют выполнять команды и собирать возвращаемые значения.

Назначение: Инкапсулируют функциональности, предоставляя простой интерфейс для их вызова.

Источники: Некоторые модули уже встроены в установленный Ansible, другие можно добавить из Ansible Galaxy.

Пример использования модуля

Для запуска сервиса HTTPD используется модуль service, в который через аргументы можно передать дополнительные параметры.

Работа с модулями

Поиск модулей:

В интернете через поисковой запрос "Ansible module list" для доступа к справочнику модулей.

Через командную строку с использованием ansible-doc, которая показывает документацию по модулям в Vim-подобном интерфейсе.

Практические советы

Изучение документации:

Сначала рассмотреть примеры использования для понимания общих сценариев.
Затем подробно ознакомиться с параметрами команд, чтобы правильно их настроить под свои задачи.

Понимание возвращаемых значений:

Важно изучить, какие значения возвращает команда, так как эти данные могут быть использованы в последующих командах внутри плейбука.


______________________________________
______________________________________
______________________________________
______________________________________
______________________________________
______________________________________

	9.8. Ad-hoc команды

Полезны для быстрых исправлений и получения информации с серверов.
Пример сравнения: docker run (разовое действие) против docker-compose (описание полного стека сервисов).

Основное содержание:

Определение и использование:

Команды для однократного выполнения задач.
Не сохраняются для последующего использования, в отличии от плейбуков.
Примеры использования: быстрые исправления, получение информации о серверах, тестирование команд.

Синтаксис:

Команда запускается с указанием хоста, модуля и аргументов (ansible -i <инвентарь> -m <модуль> -a <аргументы>).

Ограничение: можно использовать только один модуль за команду.

Практическое применение:

Создание и удаление пользователя с использованием модуля User.
Обработка ошибок и необходимость прав суперпользователя (sudo).

Параметры команды Ansible:

Различные параметры для выполнения команд, включая --ask-become-pass для запроса пароля sudo.

Примеры использования ad-hoc команд:

Создание пользователя с использованием судо.
Удаление пользователя.

Работа с переменными:

Использование переменных (--extra-vars) для передачи дополнительной информации команде.

Небезопасный метод хранения паролей в открытом доступе не рекомендуется.

______________________________________
______________________________________
______________________________________
______________________________________
______________________________________
______________________________________

	10.1. Простейший playbook

Основная концепция:
Плейбуки являются ключевым элементом Ansible, предназначенными для создания, сохранения и повторного использования скриптов конфигурации. Они служат источником документации текущей настройки инфраструктуры.

Что такое плейбук:

Описывает конфигурацию, оркестрацию или развертывание на серверах.
Может указывать на желаемое состояние системы или перечислять шаги установки.
Структура плейбука:

YAML файл начинается с имени плейбука.
Определяются группы хостов, на которых будет исполняться плейбук.
Список задач (tasks), аналогичных ad hoc командам, используя модули с параметрами.
Пример создания простого плейбука для управления пользователем:

Назначаем имя плейбуку и определяем хосты.
Вписываем задачи, например, создание пользователя с помощью модуля user и задаем параметры.
Исполнение плейбука:

Используем команду ansible-playbook с указанием инвентарного файла и самого плейбука.
Можно запросить sudo пароль через параметр -K, если необходимо.
Дополнительные функции:

В случае ошибок детали выводятся для диагностики.
Обсуждается возможность использования Vault для безопасной передачи паролей на группу серверов.	

______________________________________
______________________________________
______________________________________
______________________________________
______________________________________
______________________________________


	Основы переменных

Что такое переменные в Ansible: 

Переменные используются для динамического управления значениями в плейбуке, позволяя переиспользовать и легко изменять данные.

Применение переменных:

Переиспользование значений в разных частях плейбука или на разных серверах.
Использование разных значений в разных окружениях (например, количество инстансов на продакшене и в разработке).
Централизованное управление конфигурациями (например, настройки почты).

Ограничения использования переменных

Избегайте ключевых слов Python (Ansible построен на Python).
Не начинайте переменные со звездочки, пробелов, точек, дефисов и цифр.
Где задавать переменные
Места задания переменных: В плейбуке, блоках тасков, тасках, инвентаре, через группы GroupVars и HostVars, и используя ExtraVars.

Практическое использование переменных в Ansible

Примеры:

В таске: Прямое объявление переменной в разделе vars.
В плейбуке: Объявление переменной на уровне плейбука.
Через файл: Использование vars_files для задания переменной через внешний файл.
Используя плагин: GroupVars и HostVars для автоматического определения переменных из определенных директорий.

Приоритизация переменных

Переменные с одинаковыми именами будут перезаписаны на основе их источника и приоритета от самых низкоуровневых (например, аргументы командной строки) до самых высокоуровневых (например, ExtraVars).
Чем более специфичен контекст, в котором задана переменная, тем выше её приоритет.

Варианты задания переменных

Интерактивно с помощью vars_prompt: Позволяет запрашивать у пользователя ввод переменных при запуске плейбука.
Использование ExtraVars для динамической передачи переменных
При помощи ExtraVars можно передавать переменные при вызове плейбука, что обеспечивает большую гибкость при выполнении задач.

______________________________________
______________________________________
______________________________________
______________________________________
______________________________________
______________________________________


	10.3. Отладка

Введение 

Ansible Playbook часто рассматриваются как простые, но на практике могут быть большими и содержать много ролей и задач.
Цель отладки - понять, почему что-то не работает.

Способы отладки

Вывод в консоль

Аналогично Console.log в JavaScript.

Используется для вывода результатов команд в консоль.

В Ansible для вывода используется регистрация вывода команды с помощью ключа register и последующее использование debug для вывода зарегистрированной переменной.
Режим отладки
Включается через debugger с различными опциями (always, never, on_failed, on_unreachable, on_skip).
Позволяет запустить режим отладки перед выполнением задачи.
Пример использования вывода в консоль
Регистрация вывода команды: задаем переменную out через ключ register.
Вывод с помощью debug: используем debug, указывая out как переменную для вывода.
Пример использования режима отладки
Настройка режима: устанавливаем debugger: always для включения режима отладки независимо от обстоятельств.
Использование команд в режиме отладки:
p или print для вывода переменных.
Изменение текущих аргументов и повторное выполнение таска с помощью r (retry).
Продолжение выполнения плейбука с помощью c (continue) или обновление таска с измененными переменными через U (updateTask).	

